{{#> admin-layout title="Dashboard" isDashboard=true}}

<!-- Overview Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Tổng sản phẩm
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.totalProducts}}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-box fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Tổng danh mục
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.totalCategories}}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tags fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Tổng người dùng
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.totalUsers}}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Người dùng mới
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{stats.newUsersThisMonth}}</div>
                        <div class="text-xs text-muted">Tháng này</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-plus fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Recent Activities -->
<div class="row">
    <!-- Product Categories Chart -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>Phân bố sản phẩm theo danh mục
                </h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow">
                        <a class="dropdown-item" href="#" onclick="exportChart()">Xuất biểu đồ</a>
                        <a class="dropdown-item" href="#" onclick="refreshChart()">Làm mới</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2">
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="mt-4 text-center small">
                    {{#each categoryStats}}
                        <span class="mr-2">
                            <i class="fas fa-circle" style="color: {{this.color}}"></i> {{this.name}} ({{this.count}})
                        </span>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-clock me-2"></i>Hoạt động gần đây
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {{#each recentActivities}}
                    <div class="timeline-item">
                        <div class="timeline-marker {{this.type}}">
                            <i class="fas {{this.icon}}"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">{{this.title}}</h6>
                            <p class="timeline-description">{{this.description}}</p>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>{{formatTimeAgo this.createdAt}}
                            </small>
                        </div>
                    </div>
                    {{/each}}
                </div>
                
                {{#unless recentActivities}}
                <div class="text-center py-4">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Chưa có hoạt động nào</p>
                </div>
                {{/unless}}
            </div>
        </div>
    </div>
</div>

<!-- Recent Products and Users -->
<div class="row">
    <!-- Recent Products -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-box-open me-2"></i>Sản phẩm mới nhất
                </h6>
                <a href="/admin/products" class="btn btn-sm btn-primary">
                    Xem tất cả <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body">
                {{#if recentProducts}}
                    {{#each recentProducts}}
                    <div class="d-flex align-items-center mb-3 p-2 border rounded">
                        {{#if this.imageURL.[0]}}
                            <img src="{{this.imageURL.[0].thumbnail}}" alt="{{this.name}}" 
                                 class="rounded me-3" width="50" height="50" style="object-fit: cover;">
                        {{else}}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        {{/if}}
                        <div class="flex-grow-1">
                            <h6 class="mb-0">{{this.name}}</h6>
                            <small class="text-muted">{{this.category.name}}</small>
                            <div class="text-success fw-bold">{{formatCurrency this.price}}</div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">{{formatTimeAgo this.createdAt}}</small>
                            <br>
                            {{#if (gt this.stockQuantity 0)}}
                                <span class="badge bg-success">Còn hàng</span>
                            {{else}}
                                <span class="badge bg-secondary">Hết hàng</span>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}
                {{else}}
                    <div class="text-center py-4">
                        <i class="fas fa-box fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chưa có sản phẩm nào</p>
                        <a href="/admin/products" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Thêm sản phẩm đầu tiên
                        </a>
                    </div>
                {{/if}}
            </div>
        </div>
    </div>

    <!-- Recent Users -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-user-plus me-2"></i>Người dùng mới
                </h6>
                <a href="/admin/users" class="btn btn-sm btn-primary">
                    Xem tất cả <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body">
                {{#if recentUsers}}
                    {{#each recentUsers}}
                    <div class="d-flex align-items-center mb-3 p-2 border rounded">
                        {{#if this.avatar}}
                            <img src="{{this.avatar.url}}" alt="{{this.name}}" 
                                 class="rounded-circle me-3" width="50" height="50" style="object-fit: cover;">
                        {{else}}
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center text-white me-3" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-user"></i>
                            </div>
                        {{/if}}
                        <div class="flex-grow-1">
                            <h6 class="mb-0">{{this.name}}</h6>
                            <small class="text-muted">@{{this.username}}</small>
                            <div class="text-muted">{{this.email}}</div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">{{formatTimeAgo this.createdAt}}</small>
                            <br>
                            {{#if (eq this.role 'admin')}}
                                <span class="badge bg-danger">Admin</span>
                            {{else}}
                                <span class="badge bg-info">User</span>
                            {{/if}}
                        </div>
                    </div>
                    {{/each}}
                {{else}}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chưa có người dùng mới</p>
                    </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-server me-2"></i>Trạng thái hệ thống
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-success" id="cpu" style="width: {{systemStatus.cpuUsage}}%"></div>
                            </div>
                            <small class="text-muted" id="cpu-label">CPU: {{systemStatus.cpuUsage}}%</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-info" id="ram" style="width: {{systemStatus.memoryUsage}}%"></div>
                            </div>
                            <small class="text-muted" id="ram-label">RAM: {{systemStatus.memoryUsage}}%</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-warning" id="disk" style="width: {{systemStatus.diskUsage}}%"></div>
                            </div>
                            <small class="text-muted" id="disk-label">Disk: {{systemStatus.diskUsage}}%</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <span class="badge bg-success p-2">
                                <i class="fas fa-check-circle me-1"></i>Hệ thống hoạt động tốt
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}
.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}
.border-left-info {
    border-left: 0.25rem solid #36b9cc !important;
}
.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: white;
}

.timeline-marker.success {
    background-color: #1cc88a;
}

.timeline-marker.info {
    background-color: #36b9cc;
}

.timeline-marker.warning {
    background-color: #f6c23e;
}

.timeline-marker.danger {
    background-color: #e74a3b;
}

.timeline-content {
    background: #f8f9fc;
    padding: 15px;
    border-radius: 5px;
    border-left: 3px solid #e3e6f0;
}

.timeline-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 5px;
}

.timeline-description {
    font-size: 13px;
    color: #5a5c69;
    margin-bottom: 5px;
}
</style>

<script>
// Category Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    {{!-- const categoryData = {{{json categoryStats}}}; --}}
    
    if (categoryData && categoryData.length > 0) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categoryData.map(item => item.name),
                datasets: [{
                    data: categoryData.map(item => item.count),
                    backgroundColor: categoryData.map(item => item.color),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} sản phẩm (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } else {
        // Show empty state
        document.getElementById('categoryChart').parentElement.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                <p class="text-muted">Chưa có dữ liệu để hiển thị biểu đồ</p>
            </div>
        `;
    }
});

// Refresh dashboard data
function refreshDashboard() {
    showToast('info', 'Đang làm mới dữ liệu...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Export chart
function exportChart() {
    const canvas = document.getElementById('categoryChart');
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = 'category-chart.png';
    link.href = url;
    link.click();
    showToast('success', 'Đã xuất biểu đồ thành công!');
}

// Refresh chart
function refreshChart() {
    showToast('info', 'Đang làm mới biểu đồ...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Auto refresh every 5 minutes
setInterval(() => {
    console.log('Auto refreshing dashboard data...');
    // You can implement partial refresh here instead of full reload
}, 300000); // 5 minutes


function updateSystemStatus() {
  fetch('/admin/system/status')
    .then(res => res.json())
    .then(res => {
      if (!res.success) return;

      const { cpuUsage, memoryUsage, diskUsage } = res.data;

      // Cập nhật tiến trình
      document.querySelector('#cpu').style.width = cpuUsage + '%';
      document.querySelector('#cpu-label').textContent = 'CPU: ' + cpuUsage + '%';

      document.querySelector('#ram').style.width = memoryUsage + '%';
      document.querySelector('#ram-label').textContent = 'RAM: ' + memoryUsage + '%';

      document.querySelector('#disk').style.width = diskUsage + '%';
      document.querySelector('#disk-label').textContent = 'DISK: ' + diskUsage + '%';

    })
    .catch(err => {
      console.error('❌ Lỗi khi lấy system status:', err);
    });
}

setInterval(updateSystemStatus, 1000);
updateSystemStatus(); // Gọi ngay lần đầu



// Helper functions for Handlebars
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(amount);
}


// Register Handlebars helpers
if (typeof Handlebars !== 'undefined') {
    Handlebars.registerHelper('formatCurrency', formatCurrency);
    Handlebars.registerHelper('formatTimeAgo', formatTimeAgo);
    Handlebars.registerHelper('json', function(context) {
        return JSON.stringify(context);
    });
    Handlebars.registerHelper('eq', function(a, b) {
        return a === b;
    });
}
</script>

{{/admin-layout}}