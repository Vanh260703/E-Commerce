<style>
.review-container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e5e9;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: #007bff;
}

.rating-stars {
    display: flex;
    gap: 5px;
    margin: 10px 0;
}

.star {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s;
}

.star:hover, .star.active {
    color: #ffc107;
}

.product-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 20px;
    border-left: 4px solid #28a745;
}

.product-section h4 {
    color: #28a745;
    margin-bottom: 15px;
}

.order-section {
    background: #e3f2fd;
    padding: 20px;
    border-radius: 6px;
    margin-bottom: 20px;
    border-left: 4px solid #2196f3;
}

.order-section h4 {
    color: #1976d2;
    margin-bottom: 15px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    margin-right: 10px;
    transition: all 0.3s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.form-actions {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

/* Styles cho comment tags */
.quick-comments {
    margin-top: 10px;
}

.comment-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

.comment-tag {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}

.comment-tag:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
    transform: translateY(-1px);
}

.comment-tag.selected {
    background: #28a745;
    color: white;
    border-color: #28a745;
}
</style>

<div class="review-container">
    <h2>ÄÃ¡nh giÃ¡ Ä‘Æ¡n hÃ ng #{{order.orderCode}}</h2>
    <p>Cáº£m Æ¡n báº¡n Ä‘Ã£ mua sáº¯m táº¡i cá»­a hÃ ng. HÃ£y chia sáº» tráº£i nghiá»‡m cá»§a báº¡n!</p>

    <form id="reviewForm">
        <input type="hidden" name="userId" value="{{order.user._id}}">
        <!-- ÄÃ¡nh giÃ¡ tá»«ng sáº£n pháº©m -->
        {{#each order.items}}
        <div class="product-section">
            <h4>{{this.name}}</h4>
            <input type="hidden" name="productsReview[{{@index}}][productId]" value="{{this.product._id}}">
            
            <div class="form-group">
                <label>ÄÃ¡nh giÃ¡ sáº£n pháº©m *</label>
                <div class="rating-stars" data-rating="productsReview[{{@index}}][rating]">
                    <span class="star" data-value="1">â˜…</span>
                    <span class="star" data-value="2">â˜…</span>
                    <span class="star" data-value="3">â˜…</span>
                    <span class="star" data-value="4">â˜…</span>
                    <span class="star" data-value="5">â˜…</span>
                </div>
                <input type="hidden" name="productsReview[{{@index}}][rating]" required>
            </div>

            <div class="form-group">
                <label for="product_comment_{{@index}}">Nháº­n xÃ©t vá» {{this.product.name}}</label>
                <textarea name="productsReview[{{@index}}][comment]" 
                         id="product_comment_{{@index}}" 
                         rows="3" 
                         class="form-textarea"
                         placeholder="Chia sáº» cáº£m nháº­n cá»§a báº¡n vá» sáº£n pháº©m..."></textarea>
                
                <div class="quick-comments">
                    <small style="color: #666; margin-bottom: 8px; display: block;">ğŸ’¡ <strong>Gá»£i Ã½ nháº­n xÃ©t</strong> (click Ä‘á»ƒ thÃªm):</small>
                    <div class="comment-tags">
                        <span class="comment-tag" data-target="product_comment_{{@index}}">Ráº¥t tÆ°Æ¡i vÃ  ngon ğŸ˜‹</span>
                        <span class="comment-tag" data-target="product_comment_{{@index}}">Cháº¥t lÆ°á»£ng tá»‘t, Ä‘Ãºng nhÆ° mÃ´ táº£ ğŸ‘</span>
                        <span class="comment-tag" data-target="product_comment_{{@index}}">Äá»™ chÃ­n vá»«a pháº£i, ráº¥t hÃ i lÃ²ng ğŸ¥°</span>
                        <span class="comment-tag" data-target="product_comment_{{@index}}">ÄÃ³ng gÃ³i cáº©n tháº­n, sáº£n pháº©m ngon ğŸ“¦</span>
                        <span class="comment-tag" data-target="product_comment_{{@index}}">Sáº½ mua láº¡i láº§n sau âœ¨</span>
                        <span class="comment-tag" data-target="product_comment_{{@index}}">GiÃ¡ cáº£ há»£p lÃ½, cháº¥t lÆ°á»£ng tá»‘t ğŸ’°</span>
                        <span class="comment-tag" data-target="product_comment_{{@index}}">Hoa quáº£ tÆ°Æ¡i ngon, gia Ä‘Ã¬nh ráº¥t thÃ­ch ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                    </div>
                </div>
            </div>
        </div>
        {{/each}}

        <!-- ÄÃ¡nh giÃ¡ Ä‘Æ¡n hÃ ng -->
        <div class="order-section">
            <h4>ÄÃ¡nh giÃ¡ tá»•ng thá»ƒ Ä‘Æ¡n hÃ ng</h4>
            <input type="hidden" name="orderReview[orderId]" value="{{order._id}}">
            <div class="form-group">
                <label>ÄÃ¡nh giÃ¡ tá»•ng thá»ƒ *</label>
                <div class="rating-stars" data-rating="orderReview[rating]">
                    <span class="star" data-value="1">â˜…</span>
                    <span class="star" data-value="2">â˜…</span>
                    <span class="star" data-value="3">â˜…</span>
                    <span class="star" data-value="4">â˜…</span>
                    <span class="star" data-value="5">â˜…</span>
                </div>
                <input type="hidden" name="orderReview[rating]" required>
            </div>

            <div class="form-group">
                <label for="order_comment">Nháº­n xÃ©t vá» Ä‘Æ¡n hÃ ng</label>
                <textarea name="orderReview[comment]" 
                         id="order_comment" 
                         rows="4" 
                         class="form-textarea"
                         placeholder="Chia sáº» cáº£m nháº­n tá»•ng thá»ƒ vá» Ä‘Æ¡n hÃ ng: cháº¥t lÆ°á»£ng sáº£n pháº©m, dá»‹ch vá»¥ giao hÃ ng..."></textarea>
                
                <div class="quick-comments">
                    <small style="color: #666; margin-bottom: 8px; display: block;">ğŸ’¡ <strong>Gá»£i Ã½ nháº­n xÃ©t</strong> (click Ä‘á»ƒ thÃªm):</small>
                    <div class="comment-tags">
                        <span class="comment-tag" data-target="order_comment">Giao hÃ ng nhanh, Ä‘Ã³ng gÃ³i cáº©n tháº­n ğŸšš</span>
                        <span class="comment-tag" data-target="order_comment">Dá»‹ch vá»¥ tá»‘t, nhÃ¢n viÃªn thÃ¢n thiá»‡n ğŸ˜Š</span>
                        <span class="comment-tag" data-target="order_comment">ÄÆ¡n hÃ ng chÃ­nh xÃ¡c, khÃ´ng thiáº¿u sÃ³t gÃ¬ ğŸ“‹</span>
                        <span class="comment-tag" data-target="order_comment">Táº¥t cáº£ sáº£n pháº©m Ä‘á»u tÆ°Æ¡i ngon ğŸŒŸ</span>
                        <span class="comment-tag" data-target="order_comment">Sáº½ Ä‘áº·t hÃ ng thÆ°á»ng xuyÃªn â™»ï¸</span>
                        <span class="comment-tag" data-target="order_comment">Cá»­a hÃ ng uy tÃ­n, Ä‘Ã¡ng tin cáº­y ğŸª</span>
                        <span class="comment-tag" data-target="order_comment">Giao Ä‘Ãºng giá» nhÆ° háº¹n â°</span>
                        <span class="comment-tag" data-target="order_comment">GiÃ¡ cáº£ cáº¡nh tranh, cháº¥t lÆ°á»£ng tá»‘t ğŸ’¯</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- NÃºt submit -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Gá»­i Ä‘Ã¡nh giÃ¡</button>
            <a href="/" class="btn btn-secondary">Quay vá» trang chá»§</a>
        </div>
    </form>
</div>

<script>
// Xá»­ lÃ½ rating stars
document.querySelectorAll('.rating-stars').forEach(ratingGroup => {
    const stars = ratingGroup.querySelectorAll('.star');
    const ratingName = ratingGroup.dataset.rating;
    const hiddenInput = document.querySelector(`input[name="${ratingName}"]`);
    
    stars.forEach((star, index) => {
        star.addEventListener('click', () => {
            const rating = index + 1;
            hiddenInput.value = rating;
            
            // Cáº­p nháº­t tráº¡ng thÃ¡i visual
            stars.forEach((s, i) => {
                s.classList.toggle('active', i < rating);
            });
        });
        
        star.addEventListener('mouseenter', () => {
            stars.forEach((s, i) => {
                s.style.color = i <= index ? '#ffc107' : '#ddd';
            });
        });
    });
    
    ratingGroup.addEventListener('mouseleave', () => {
        const currentRating = parseInt(hiddenInput.value) || 0;
        stars.forEach((s, i) => {
            s.style.color = i < currentRating ? '#ffc107' : '#ddd';
        });
    });
});

// Xá»­ lÃ½ comment tags - TÃNH NÄ‚NG Má»šI
document.querySelectorAll('.comment-tag').forEach(tag => {
    tag.addEventListener('click', () => {
        const targetId = tag.dataset.target;
        const textarea = document.getElementById(targetId);
        const comment = tag.textContent.trim();
        
        // ThÃªm comment vÃ o textarea
        if (textarea.value.trim() === '') {
            textarea.value = comment;
        } else {
            // ThÃªm vÃ o cuá»‘i vá»›i dáº¥u phÃ¢n cÃ¡ch
            const currentValue = textarea.value.trim();
            const separator = currentValue.endsWith('.') || currentValue.endsWith('!') || currentValue.endsWith('ğŸ˜Š') ? ' ' : '. ';
            textarea.value = currentValue + separator + comment;
        }
        
        // Visual feedback
        tag.classList.add('selected');
        setTimeout(() => {
            tag.classList.remove('selected');
        }, 1000);
        
        // Focus vÃ o textarea vÃ  scroll
        textarea.focus();
        textarea.scrollTop = textarea.scrollHeight;
    });
});

// Validation form
document.getElementById('reviewForm').addEventListener('submit', async function(e) {
    e.preventDefault(); 
    const requiredRatings = this.querySelectorAll('input[name*="rating"][required]');
    let isValid = true;
    
    requiredRatings.forEach(input => {
        if (!input.value) {
            isValid = false;
            const ratingGroup = this.querySelector(`[data-rating="${input.name}"]`);
            if (ratingGroup) {
                ratingGroup.style.border = '2px solid #dc3545';
                ratingGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Vui lÃ²ng Ä‘Ã¡nh giÃ¡ Ä‘áº§y Ä‘á»§ táº¥t cáº£ sáº£n pháº©m vÃ  Ä‘Æ¡n hÃ ng!');
    }

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    const parsedData = {
        reviewerName: data.reviewerName,
        reviewerEmail: data.reviewerEmail,
        userId: data.userId,
        productsReview: [],
        orderReview: {}
    };

    // Parse productsReview
    Object.keys(data).forEach(key => {
        const match = key.match(/^productsReview\[(\d+)\]\[(\w+)\]$/);
        if (match) {
            const index = parseInt(match[1]);
            const field = match[2];
            if (!parsedData.productsReview[index]) {
                parsedData.productsReview[index] = {};
            }
            parsedData.productsReview[index][field] = data[key];
        }
    });

    // Parse orderReview
    Object.keys(data).forEach(key => {
        const match = key.match(/^orderReview\[(\w+)\]$/);
        if (match) {
            const field = match[1];
            parsedData.orderReview[field] = data[key];
        }
    });

    // Ã©p kiá»ƒu sá»‘
    parsedData.productsReview = parsedData.productsReview.map(p => ({
        ...p,
        rating: Number(p.rating),
    }));
    if (parsedData.orderReview.rating) {
        parsedData.orderReview.rating = Number(parsedData.orderReview.rating);
    }

    try {
       const response = await fetch('/review/submit-review', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(parsedData),
       });

       const result = await response.json();

       if (result.success) {
        showToast('success', result.message);
        setTimeout(() => window.location.href = "https://b597dbe3ce5d.ngrok-free.app/products", 1000);
       } else {
        showToast('error', result.message);
       }
    } catch (err) {
        console.log(err);
        showToast('error', 'CÃ³ lá»—i xáº£y');
    }
});
</script>